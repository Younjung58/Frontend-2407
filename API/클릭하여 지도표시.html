<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>클릭해서 지도생성</title>
    <script src="key.js"></script>
    <script>
        window.onload = () => {
            const kakaoScript = document.createElement('script');
            kakaoScript.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoJsKey}&autoload=false&libraries=services`;
            kakaoScript.onload = () => {
                kakao.maps.load(() => {
                    initializeMap();
                });
            };
            document.head.appendChild(kakaoScript);
        }

        function initializeMap(){
            let infowindow = new kakao.maps.InfoWindow({zIndex:1});

            let mapContainer = document.getElementById('map'),
                mapOption = {
                    center: new kakao.maps.LatLng(37.566826, 126.9786567), 
                    level: 3 
                };  

            let map = new kakao.maps.Map(mapContainer, mapOption); 

            let ps = new kakao.maps.services.Places(); 
            document.getElementById('searchBtn').addEventListener('click', function() {
                let keyword = document.getElementById('keyword').value;
                ps.keywordSearch(keyword, placesSearchCB); 
            });

            function placesSearchCB(data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
                    let bounds = new kakao.maps.LatLngBounds();
                    for (let i = 0; i < data.length; i++) {
                        displayMarker(data[i]);    
                        bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
                    }
                    map.setBounds(bounds);
                } else {
                    console.error('검색 결과 없음 또는 오류:', status);
                }
            }

            function displayMarker(place) {
                let marker = new kakao.maps.Marker({
                    map: map,
                    position: new kakao.maps.LatLng(place.y, place.x) 
                });

                kakao.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
                    infowindow.open(map, marker);

                    const coords = `${place.x},${place.y}`;
                    const url = `https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${place.x}&y=${place.y}`;
                    const headers = { 'Authorization': `KakaoAK ${kakaoRestKey}` };

                    fetch(url, { headers })
                        .then(response => response.json())
                        .then(data => {
                            if (data.documents && data.documents.length > 0) {
                                const address = data.documents[0].address.address_name;
                                alert(`주소: ${address}`);
                            } else {
                                console.log('주소를 찾을 수 없습니다.');
                            }
                        })
                        .catch(error => console.error('에러 발생:', error));
                });
            }
        }
    </script>
</head>
<body style="margin: 40px;">
    <input type="text" id="keyword" placeholder="검색어를 입력하세요" style="width: 80%; padding: 10px; margin-right: 10px;">
    <button id="searchBtn" style="padding: 10px;">검색</button>
    <div id="map" style="width:100%;height:350px;margin-top:20px;"></div>
</body>
</html>