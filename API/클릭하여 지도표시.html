<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>클릭해서 지도생성</title>
    <script src="key.js"></script>
    <script>
        window.onload = () => {
            const kakaoScript = document.createElement('script');
            kakaoScript.src = `http://dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoJsKey}&autoload=false&libraries=services`;
            kakaoScript.onload = () => {
                kakao.maps.load(() => {
                    initializeMap();
                });
            };
            document.head.appendChild(kakaoScript);
        }

        function initializeMap(){
            let infowindow = new kakao.maps.InfoWindow({zIndex:1});

            let mapContainer = document.getElementById('map'), // 지도를 표시할 div 
                mapOption = {
                    center: new kakao.maps.LatLng(37.566826, 126.9786567), // 지도의 중심좌표
                    level: 3 // 지도의 확대 레벨
                };  

            // 지도를 생성합니다    
            let map = new kakao.maps.Map(mapContainer, mapOption); 

            // 장소 검색 객체를 생성합니다
            let ps = new kakao.maps.services.Places(); 
            document.getElementById('searchBtn').addEventListener('click', function() {
                let keyword = document.getElementById('keyword').value;
                ps.keywordSearch(keyword, placesSearchCB); 
            });

            // 키워드 검색 완료 시 호출되는 콜백함수 입니다
            function placesSearchCB(data, status, pagination) {
                console.log('검색 결과:', data, status);
                if (status === kakao.maps.services.Status.OK) {
                    let bounds = new kakao.maps.LatLngBounds();
                    for (let i = 0; i < data.length; i++) {
                        displayMarker(data[i]);    
                        bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
                    }
                    map.setBounds(bounds);
                } else {
                    console.log('검색 결과 없음 또는 오류:', status);
                }
            }

            // 지도에 마커를 표시하는 함수입니다
            function displayMarker(place) {
                // 마커를 생성하고 지도에 표시합니다
                let marker = new kakao.maps.Marker({
                    map: map,
                    position: new kakao.maps.LatLng(place.y, place.x) 
                });

                // 마커에 클릭이벤트를 등록합니다
                kakao.maps.event.addListener(marker, 'click', function() {
                    // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
                    infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
                    infowindow.open(map, marker);
                });

                // Kakao REST API로 주소 변환
                const coords = `${place.x},${place.y}`;
                const url = `https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${place.x}&y=${place.y}`;
                const headers = { Authorization: `KakaoAK ${kakaoRestKey}` };

                fetch(url, { headers })
                    .then(response => response.json())
                    .then(data => {
                        if (data.documents && data.documents.length > 0) {
                            const address = data.documents[0].address.address_name;
                            console.log('주소:', address);
                        } else {
                            console.log('주소를 찾을 수 없습니다.');
                        }
                    })
                    .catch(error => console.error('에러 발생:', error));
            }
        }
    </script>
</head>
<body style="margin: 40px;">
    <input type="text" id="keyword" placeholder="검색어를 입력하세요" style="width: 80%; padding: 10px; margin-right: 10px;">
    <button id="searchBtn" style="padding: 10px;">검색</button>
    <div id="map" style="width:100%;height:350px;margin-top:20px;"></div>
</body>
</html>